name: pre-merge checks
on: 
  pull_request:
    branches: [main]
  push:
    branches: [main]
  
jobs:  
  pip_audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pypa/gh-action-pip-audit@v1.0.0
        with:
          inputs: requirements.txt
  
  bandit_vuln_check:
    name: Dependency vulnerability check
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v6
      - name: Bandit Analysis
        uses: PyCQA/bandit-action@v1
        with:
          severity: high
          confidence: high
          
  credential-testing:
    name: Trufflehog secret scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Trufflehog Secret Scanning
        id: trufflehog_secret
        continue-on-error: true
        env:
          SCAN_PATH: "."
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin
          trufflehog filesystem . > ./results.txt
          cat ./results.txt
          
  black_linter:
    name: Black formatter
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: rickstaa/action-black@v1
        with:
          black_args: ". --check"

  discord_notify:
    needs: ["pip_audit", "bandit_vuln_check", "credential-testing", "black_linter"]
    name: Notify Discord on fail
    runs-on: ubuntu-latest
    environment: Main
    if: failure()
    steps:
      - name: Notify Discord
        env: # Or as an environment variable
          discord_webhook: ${{ secrets.GITHUB_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" -d '{"username": "test", "content": "Workflow Failed - "}' "$discord_webhook" 
